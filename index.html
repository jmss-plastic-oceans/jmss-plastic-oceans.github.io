<!DOCTYPE html>
<html>
<head>
	<title>Plastic Oceans 2</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Comfortaa' rel='stylesheet'>
	<link rel="icon" href="favicon.png">
	<link rel="stylesheet" type="text/css" href="index.css">

	<noscript>

		Javascript not enabled. Please enable to ensure website functionality.

	</noscript>

</head>
<body>
	<div class="logopic">
		<img src="images/poalogo.png" class="logo">
		<img src="images/ps.png" class="logo">
	</div>

	<br>

	<div class="nav-row" id="row">
		<div class="navbar" id="navbar">
			<a href="#" class="nav">Home</a>
			<a href="mission.html" class="nav">Our Mission</a>
			<a href="#" class="nav">Newsletter</a>
			<a href="getinvolved.html" class="nav">Get Involved</a>
			<a href="#" class="nav">Store</a>
			<a href="contact.html" class="nav">Contact</a>
		</div>
	</div>

	<div class="intro"><img src="images/intro1.png" height="100%" width="100%"></div>

	<div id="updates" class="updates">

		<br>
		<h2>NEWSLETTER</h2>
		<br>

		<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin: auto; background: rgb(241, 242, 243); display: block; shape-rendering: auto;" width="50px" height="50px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" id="articles-loading">
			<rect x="19" y="19" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0s" calcMode="discrete"></animate>
			</rect><rect x="40" y="19" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.125s" calcMode="discrete"></animate>
			</rect><rect x="61" y="19" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.25s" calcMode="discrete"></animate>
			</rect><rect x="19" y="40" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.875s" calcMode="discrete"></animate>
			</rect><rect x="61" y="40" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.375s" calcMode="discrete"></animate>
			</rect><rect x="19" y="61" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.75s" calcMode="discrete"></animate>
			</rect><rect x="40" y="61" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.625s" calcMode="discrete"></animate>
			</rect><rect x="61" y="61" width="20" height="20" fill="#1d3f72">
			  <animate attributeName="fill" values="#5699d2;#1d3f72;#1d3f72" keyTimes="0;0.125;1" dur="1s" repeatCount="indefinite" begin="0.5s" calcMode="discrete"></animate>
			</rect>
		</svg> <p id="loading-msg">Please wait, articles are loading...</p>

		<!-- Articles will be generated by Javascript and appended here! -->


	</div>

</div>
	<div class="footer">
		<div class="footer-row">
			<div class="col-sm-6">
				<strong>Captains:</strong>

				
			</div>
			<div class="col-sm-6">
				Contacts: <br>
				Email: <br>
				<strong>Plastic Oceans <br>
				Australiasia</strong>

			</div>
		</div>
		
	</div>


<script>

// ------------------------------------------
// Google Docs API Setup
// ------------------------------------------

// Client ID and API key from the Developer Console
var CLIENT_ID = '993150457622-n59rultal6d83unt3ivuq58uspmcvgan.apps.googleusercontent.com'
var API_KEY = 'AIzaSyAhkzGVQL90Ne2o0P1IPs5pTxv16N6ebMk';

// Array of API discovery doc URLs for APIs used by the quickstart
var DISCOVERY_DOCS = ['https://docs.googleapis.com/$discovery/rest?version=v1'];

// Authorization scopes required by the API; multiple scopes can be
// included, separated by spaces.
var SCOPES = "https://www.googleapis.com/auth/documents.readonly";

/**
*	On load, called to load the auth2 library and API client library.
*/
function handleClientLoad() {
	gapi.load('client:auth2', initClient);
}

/**
 *	Initializes the API client library and sets up sign-in state
	*	listeners.
	*/
function initClient() {
	gapi.client.init({
		apiKey: API_KEY,
		clientId: CLIENT_ID,
		discoveryDocs: DISCOVERY_DOCS,
		scope: SCOPES
	}).then(() => {
		articleSetup();
	});
}

function getGDocContent(docId) {

	return new Promise(resolve => {

		let content = [];

		gapi.client.docs.documents.get({
			documentId: docId
		}).then(function(response) {

			var doc = response.result;

			Array.from(doc.body.content).forEach(element => {
				console.dir(element);
				try {
					content.push(element.paragraph.elements[0].textRun.content.trim()); 
				} catch (e) {
					console.error(e)
				}
			});

			resolve(content);

		}, function(response) {
			console.error(response.result.error.message);
		});

	});

}

// ----------------------------------
// Get articles
// ----------------------------------

var csvData;

async function articleSetup() {

	let updatesWrapper = document.getElementById("updates");
	let docIdRegex = new RegExp('https://docs.google.com/document/d/(.*)/');
	const ARTICLE_GSHEET_URL = "https://docs.google.com/spreadsheets/d/1JJ5EX-8RbNiuJ28sq_SwswLtMyHY9yy61s1oLEyM5mA/export?format=csv";

	fetch(ARTICLE_GSHEET_URL)
		.then((response) => {	
			response.text().then(text => {

				csvData = text.split("\n")
				csvData.forEach(function(val, index) {
					this[index] = val.split(",");
				}, csvData);

				csvData.shift();
				console.dir(csvData)
				appendArticles(csvData);
			});
			return response;
		})
		.then((data) => {
			console.dir(data);
		});
	
	function appendArticles(csvData) {

		csvData.forEach(function (val, index) {

			console.log("Adding following article to site...");
			console.dir(val);

			// Get Google Docs content based on spreadsheet URL		
			getGDocContent(val[2].match(docIdRegex)[1]).then(articleContent => {

				// Choose whether image/text is aligned left or right alternatively
				let leftRight = (index%2) ? "left":"right";

				// Create new elements
				let newArticleWrapper = document.createElement("div");
				newArticleWrapper.classList.add("article");

				let newArticleLink = document.createElement("a");
				newArticleLink.classList.add("article-link");
				newArticleLink.href = val[2];
				newArticleWrapper.appendChild(newArticleLink);

				let newArticleLinkDiv = document.createElement("div");
				newArticleLinkDiv.classList.add(leftRight + "-title");

				let newArticleLinkDivImage = document.createElement("img");
				newArticleLinkDivImage.src = val[3];
				newArticleLinkDivImage.classList.add(leftRight + "-img");
				newArticleLinkDivImage.align = leftRight;

				let newArticleContentWrapper = document.createElement("div");
				newArticleContentWrapper.classList.add("title-text");

				let newArticleContentTitle = document.createElement("h5");
				newArticleContentTitle.classList.add("article-title");
				newArticleContentTitle.innerHTML = val[0];

				let newArticleContentSubtitle = document.createElement("h6");
				newArticleContentSubtitle.classList.add("article-subtitle");
				newArticleContentSubtitle.innerHTML = val[1]

				let newArticleContentBody = document.createElement("p");
				newArticleContentBody.classList.add("article-content");
				newArticleContentBody.innerHTML = articleContent.join("\n").substring(0,500) + "...";

				// Append elements to each other
				newArticleContentWrapper.appendChild(newArticleContentTitle);
				newArticleContentWrapper.appendChild(newArticleContentSubtitle);
				newArticleContentWrapper.appendChild(newArticleContentBody);

				newArticleLinkDiv.appendChild(newArticleLinkDivImage);
				newArticleLinkDiv.appendChild(newArticleContentWrapper);

				newArticleLink.appendChild(newArticleLinkDiv);

				newArticleWrapper.appendChild(newArticleLink);

				updatesWrapper.appendChild(newArticleWrapper);

				document.getElementById("loading-msg").innerText = "Please wait, articles are loading... (" + Math.round(((index+1)/csvData.length)*1000)/10 + "%)";
				console.log("Finished!");

			}, error => {
				console.error(error);
			});
		});

		document.getElementById("articles-loading").style.display = "none";
		document.getElementById("loading-msg").style.display="none";

	}
}

setTimeout(function () {
	if (document.getElementById("articles-loading").style.display != "none") {
		document.getElementById("loading-msg").innerText = "We're having trouble loading the GDocs API at the moment. Please try again later.";
	}
}, 30000)

</script>

<script async="true" defer="true" onload="this.onload=function(){};handleClientLoad();" onreadystatechange="if (this.readyState === 'complete') this.onload()" src="https://apis.google.com/js/api.js"></script>

</body>
</html>